"use strict";var U={extend:function(a,b){var c=new Function();c.prototype=a.prototype;b.prototype=new c();b.prototype.constructor=b;b.superclass=a.prototype},Super:function(b,c,d,a){b.superclass[c].apply(d,a)},sz:function(a){return(a.length?a.length:0)},round:function(a){return Math.round(a)},"int":function(b,a){if(!a){a=10}return parseInt(b,a)},rand:function(c,a){var f=Math.random(),d=String(f),b=a-c,e=String(b).length;d=d.split(".")[1];if(d){d=d.replace(/^0+/,"");d=d.substring(0,e)}while(!d||d.length<e){f=Math.random();d=String(f);d=d.split(".")[1];if(d){d=d.replace(/^0+/,"");d=d.substring(0,e)}}f=parseInt(d)%b;if(f==0){e=U.rand(1000,9999);if(e%2==0){f=b}}f+=c;return f},time:function(){return parseInt(new Date().getTime()/1000)},getPercents:function(c,b){var a=b/100;return(c*a)}};function Graphics(a){this.TYPE_POINT=1,this.TYPE_RECT=2;this._objects=[];this._color=0;this._fill_color=16777215;this._thikness=0.25;this._is_begin_fill=false;this._is_end_fill=false;this._parent=a}Graphics.prototype.lineTo=function(a,f){var e=this._last_object,d={},c,b;if(!e){Error("need call moveTo before drawLine")}if(e.type==this.TYPE_RECT){Error("need call moveTo before drawRect")}b=this.TYPE_POINT;this._applyLineStyle(d);if(d.clr==e.color){d.clr=null}if(d.thi==e.thikness){d.thi=null}if(this._parent._width<a){this._parent.setWidth(a,1)}if(this._parent._height<f){this._parent.setHeight(f,1)}c=this._createPoint(b,a,f,d.clr,d.thi);this._last_object=c;this._objects.push(c);this._parent.visible=true};Graphics.prototype.moveTo=function(b,f){var c=this.TYPE_POINT,e={},a,d;this._applyLineStyle(e);a=this._createPoint(c,b,f,e.clr,e.thi,true);d=this._last_object;this._objects.push(a);this._last_object=a};Graphics.prototype.drawRect=function(b,e,c,a){var d={type:this.TYPE_RECT,x:b,y:e,w:c,h:a,color:this._color,thikness:this._thikness,fill_color:this._is_begin_fill&&!this._is_end_fill?this._fill_color:false};this._objects.push(d);this._last_object=d;if(this._parent._width<b+c){this._parent.setWidth(b+c,1)}if(this._parent._height<e+a){this._parent.setHeight(e+a,1)}this._parent.visible=true};Graphics.prototype.beginFill=function(a){this._fill_color=a;this._is_begin_fill=true;this._is_end_fill=false;this._parent.visible=true};Graphics.prototype.setLineStyle=function(b,a){this._new_color=a;this._new_thikness=b;this._parent.visible=true};Graphics.prototype.lineStyle=function(b,a){this.setLineStyle(b,a)};Graphics.prototype.endFill=function(){this._is_end_fill=true;this._objects[this._objects.length-1].is_end_fill=true};Graphics.prototype._applyLineStyle=function(c){var a,b;if(this._new_color!==this._color){a=this._color=this._new_color;this._new_color=null}else{a=this._color}if(this._new_thikness&&this._new_thikness!=this._thikness){b=this._thikness=this._new_thikness;this._new_thikness=null}else{b=this._thikness}c.clr=a;c.thi=b};Graphics.prototype._createPoint=function(d,h,e,c,f,j,b,g){if(!b){b=this._is_begin_fill;this._is_begin_fill=false}var i=false,a;i=this._fill_color;a={type:d,x:h,y:e,color:c,fill_color:i,thikness:f,is_start:j,is_begin_fill:b,is_end_fill:g};return a};Graphics.prototype.clear=function(){this._objects=[];this._color=0;this._fill_color=16777215;this._thikness=0.25;this._is_begin_fill=false;this._is_end_fill=false};function Sprite(a,c,b){this.initSprite(a,c,b)}Sprite.prototype.initSprite=function(a,c,b){this.cells=[];this.nearSprites=[];this.dc;this.is_image=0;this.visible=0;this.img=a;this.sourceW=this.w=this._width=a&&a.width?a.width:0;this.sourceH=this.h=this._height=a&&a.height?a.height:0;this._scaleX=this._scaleY=1;Object.defineProperty(this,"scaleX",{enumerable:true,get:function(){return this._scaleX},set:function(d){this._scaleX=d;this.setWidth(this.sourceW*d)}});Object.defineProperty(this,"scaleY",{enumerable:true,get:function(){return this._scaleY},set:function(d){this._scaleY=d;this.setHeight(this.sourceH*d)}});this.se2d=window.SE2D;this.id=c;this.depth=b;this.name;this.graphics=new Graphics(this);this.childs=[];this.childsMap={};this.go(0,0)};Sprite.prototype.hitTest=function(b,d){var c=b,e=this,a=false;if((c.x+c.w)>=e.x&&c.x<=(e.x+e.w)&&(c.y+c.h)>=e.y&&c.y<=(e.y+e.h)){a=true}if(a&&d){delete d.t;delete d.r;delete d.b;delete d.l;if((c.x+c.w)>=e.x&&(c.x+c.w)<=(e.x+e.w)){d.r=1}if(c.x>=e.x&&c.x<=(e.x+e.w)){d.l=1}if((c.y+c.h)>=e.y&&(c.y+c.h)<=(e.y+e.h)){d.b=1}if(c.y>=e.y&&c.y<=(e.y+e.h)){d.t=1}}return a};Sprite.prototype.hitTestPoint=function(a,c){var b=this;if(b.x<=a&&(b.x+b.w)>=a&&b.y<=c&&(b.y+b.h)>=c){return true}return false};Sprite.prototype.clone=function(a,h,g,e){var d=this,f=(d.clone_id_counter?d.clone_id_counter+1:0),b=new Sprite(d.img,d.id+"_"+f,SE2D.sprites.length);d.clone_id_counter=f+1;SE2D._root[d.id+"_"+f]=b;SE2D.sprites.push(b);b.parentClip=SE2D._root;if(e){b.visible=e}b.go(a,h);if(g){b.id=g}b.orign=d;return b};Sprite.prototype.go=function(q,n){var l=window.SE2D,c=this,g,m=U.sz(c.cells),b=c.id,d;c.x=q;c.y=n;if(0==c.visible||1==c.is_image||!l.gridCell||!l.grid){return}for(g=0;g<m;g++){d=c.cells[g][0]+"_"+c.cells[g][1];if(l.grid[d]){delete l.grid[d][b]}}c.cells=[];c.nearSprites=[];var a={},p,r,k,h={},f;function e(i,t){var s=l.gridCell,j=Math.floor(i/s),o=Math.floor(t/s);return{r:o,c:j}}k=[{x:c.x,y:c.y},{x:c.x+c.w,y:c.y},{x:c.x+c.w,y:c.y+c.h},{x:c.x,y:c.y+c.h}];for(g=0;g<4;g++){r=e(k[g].x,k[g].y);p=r.r+"_"+r.c;if(!a[p]){a[p]=1;c.cells.push([r.r,r.c]);if(!l.grid[p]){l.grid[p]={}}l.grid[p][b]=1;for(f in l.grid[p]){if(f!=b&&!h[f]){h[f]=1;c.nearSprites.push(f)}}}}c.dc=c.nearSprites.length};Sprite.prototype.addChild=function(b){var d,e=this,f=e.childs,a=f.length;b.removeFromParentScope();if(!b.id){b.id="s"+a}b.depth=a;b.parentClip=e;f.push(b);this.childsMap[b.id]=f.length-1};Sprite.prototype.removeFromParentScope=function(){var c=this,f=c.parentClip,b,a,e=[],g={},h,d="childsMap";if(!f){return false}if(f.isRoot){h=SE2D.sprites}else{h=f.childs}if(c.id){a=h.length;for(b=0;b<a;b++){if(h[b].id!==c.id){e.push(h[b])}}if(f.isRoot){SE2D.sprites=e}else{f.childs=e}if(f instanceof Sprite){for(b in f[d]){if(b!==c.id){g[b]=f[d][b]}}f[d]=g}else{if(f.isRoot){for(b in f){if(b!==c.id){g[b]=f[b]}}f=g}}}};Sprite.prototype.setWidth=function(a,b){this.w=this._width=a;if(b){this.sourceW=a}};Sprite.prototype.setHeight=function(a,b){this.h=this._height=a;if(b){this.sourceH=a}};Sprite.prototype.setMouseXY=function(){if(SE2D.mouseX){this.mouseX=SE2D.mouseX-this.x;this.mouseY=SE2D.mouseY-this.y}};Sprite.prototype.fromObject=function(d,c){var b,a;if(c.text){b=new TextField(c.name);b.stroke=c.stroke;b.textFormat=c.textFormat}else{b=new Sprite(null,c.name,0)}b.graphics=new Graphics(b);b.graphics._objects=c.graphics;b.setHeight(+c.h?+c.h:0,1);b.setWidth(+c.w?+c.w:0,1);b.rotation=c.rotation;b.x=c.x;b.y=c.y;b.visible=true;if(c.text){b.text=c.text}for(a=0;a<c.numChildren;a++){this.fromObject(b,c.children[a])}d.addChild(b)};Sprite.prototype.clear=function(){this.graphics.clear();for(var a=0;a<this.childs.length;a++){this.childs[a].clear()}};Sprite.prototype.removeAllChilds=function(){this.childs=[];this.childsMap={}};Sprite.prototype.getChildByName=function(a){return((this.childsMap[a]||this.childsMap[a]===0)&&this.childs[this.childsMap[a]]?this.childs[this.childsMap[a]]:null)};function TextFormat(b,c,a){this.font=b?b:"Times";this.size=c?c:12;this.color=a?a:0}function TextField(a){this.initSprite(null,a,0);this.textFormat=new TextFormat();Object.defineProperty(this,"textWidth",{enumerable:true,get:function(){return(+this._textWidth?+this._textWidth:0)}});Object.defineProperty(this,"text",{enumerable:true,get:function(){return this._text},set:function(b){this._text=b;this._textWidth=this._getTextWidth(b)}})}U.extend(Sprite,TextField);TextField.prototype.setTextFormat=function(a){this.textFormat=a};TextField.prototype.getTextFormat=function(){return this.textFormat};TextField.prototype._getTextWidth=function(a){var b=SE2D.c;b.font=this.textFormat.size+"px "+this.textFormat.font;return b.measureText(a).width};function SimpleEngine2D(c,a){var b=document.getElementById(c);if(b&&b.getContext){if(!window.SE2D){window.SE2D=this}this.test="000";this.c=b.getContext("2d");this.canvas=b;this.canvas.onclick=this.onclick;this.canvas.onmousemove=this.onMouseMove;this.w=b.width;this.h=b.height;this.fps=a;this.rastrData=[];this.sprites=[];this._root={addChild:function(d){var e=d,f=e.id;if(e.id=="isRoot"||e.id=="addChild"){Error('Invalid name of the clip "'+e.id+'"')}if(!f){e.id=f="s"+SE2D.sprites.length}e.parentClip=SE2D._root;SE2D.sprites.push(e);SE2D._root[f]=e},isRoot:true};this.grid={};this.__images_length=-1;this.gridCell;setInterval(this.tick,1000/a)}else{}}SimpleEngine2D.prototype.onEnterFrame=function(){};SimpleEngine2D.prototype.onLoadImages=function(){};SimpleEngine2D.prototype.onLoadRastrResource=function(){};SimpleEngine2D.prototype.tick=function(){var c=SE2D.sprites.length,b,a;SE2D.c.clearRect(0,0,SE2D.w,SE2D.h);for(b=0;b<c;b+=1){a=SE2D.sprites[b];if(a.visible!=false){SE2D.draw(a);a.setMouseXY()}}SE2D.onEnterFrame()};SimpleEngine2D.prototype.draw=function(q,h,f,m){var j=q.childs,g,l=j.length,d,b,a;h=h?h:0;f=f?f:0;d=q.scaleX;b=q.scaleY;a=q;while(a.parentClip){a=a.parentClip;if(!a.isRoot){d*=a.scaleX;b*=a.scaleY}}m=+m?+m:0;if(q instanceof TextField){var p=q.getTextFormat(),k=SE2D.c,n=k.fillStyle,e=k.strokeStyle;k.fillStyle=SE2D.parseColor(p.color);k.strokeStyle=SE2D.parseColor(p.color);k.font=p.size+"px "+p.font;if(!q.stroke){k.fillText(q.text,(q.x+h)*d,(q.y+f)*b+p.size)}else{k.strokeText(q.text,(q.x+h)*d,(q.y+f)*b+p.size)}k.fillStyle=n;k.strokeStyle=e}if(q.img){if(!q.fixSize){SE2D.c.drawImage(q.img,(q.x+h)*d,(q.y+f)*b,q.img.width*d,q.img.height*b)}else{SE2D.c.drawImage(q.img,(q.x+h)*d,(q.y+f)*b)}}if(q.graphics._objects.length){SE2D.drawGraphics(q.graphics,(q.x+h)*d,(q.y+f)*b,(q.id=="s1"))}for(g=0;g<l;g++){if(j[g].visible){SE2D.draw(j[g],(q.x+h),(q.y+f),m+1)}}};SimpleEngine2D.prototype.addRastr=function(c,b){var a=new Image();this.rastrData.push(a);a.depth=this.rastrData.length-1;a.se2d=this;a.id=b;a.onload=this.onLoadImage;a.onerror=this.onErrorLoadImage;a.src=c};SimpleEngine2D.prototype.addGraphResources=function(a){var d=U.sz(a),b=0,c=d/2;if(c!=Math.round(c)){throw"Need odd count items in first arument for SE2D.addGraphResources"}this.__images_count=this.__images_length=d/2;for(b=0;b<d;b+=2){if(b+1<d){this.addRastr(a[b],a[b+1])}}};SimpleEngine2D.prototype.onLoadImage=function(){var a=this,c=a.se2d,b=new Sprite(a,a.id,a.depth);c._root[a.id]=b;c.sprites.push(b);b.parentClip=c._root;c.__images_count--;SE2D.onLoadRastrResource(a.id);if(c.__images_count==0){c.orderImagesByDepth();c.onLoadImages()}};SimpleEngine2D.prototype.onErrorLoadImage=function(){SE2D.__images_count--;if(SE2D.__images_count==0){SE2D.onLoadImages()}};SimpleEngine2D.prototype.orderImagesByDepth=function(){var g=SE2D.sprites.length,d,c,f,e;for(d=0;d<g;d+=1){for(c=0;c<g;c+=1){f=SE2D.sprites[d];e=SE2D.sprites[c];if(f.depth<e.depth){var a=SE2D.sprites[d];SE2D.sprites[d]=SE2D.sprites[c];SE2D.sprites[c]=a}}}};SimpleEngine2D.prototype.setButtons=function(b){var a;for(a=0;a<U.sz(b);a++){if(this._root[b[a]]){this._root[b[a]].is_button=1}}};SimpleEngine2D.prototype.onclick=function(d){SE2D.onMouseMove(d);var a=SE2D.mouseX,f=SE2D.mouseY,c,b;for(b=0;b<U.sz(SE2D.sprites);b++){c=SE2D.sprites[b];if(c&&c.is_button==1){if(c.onclick instanceof Function&&c.hitTestPoint(a,f)){c.onclick({x:a,y:f,target:c})}}}};SimpleEngine2D.prototype.onMouseMove=function(a){SE2D.mouseX=a.x||a.layerX||(a.clientX-SE2D.canvas.offsetLeft);SE2D.mouseY=a.y||a.layerY||(a.clientY-SE2D.canvas.offsetTop)};SimpleEngine2D.prototype.remove=function(c){var a,b=[];if(!(c instanceof Sprite)){c=SE2D._root[c]}if(!(c instanceof Sprite)){return}for(a=0;a<SE2D.sprites.length;a++){if(SE2D.sprites[a]!=c){b.push(SE2D.sprites[a])}}SE2D.sprites=b;for(a in SE2D._root){if(SE2D._root[a]==c){delete SE2D._root[a]}}};SimpleEngine2D.prototype.drawGraphics=function(r,f,e,h){var q,g=r._objects,b=g.length,t=SE2D.c,l,n,m,u=r._parent.scaleX,s=r._parent.scaleY,o=0,d=r._parent,a=d;var k=u,i=s;t.strokeStyle="#000000";while(a.parentClip){a=a.parentClip;if(!a.isRoot){k*=a.scaleX;i*=a.scaleY}}u=k;s=k;for(q=0;q<b;q++){l=g[q];if(l.type){if(l.type==r.TYPE_POINT){if(l.is_start){n=l}if(l.thikness){t.lineWidth=l.thikness}if(l.color||l.color==0){m=this.parseColor(l.color);t.strokeStyle="#000000"}if(l.is_begin_fill&&l.fill_color){m=this.parseColor(l.fill_color);t.fillStyle=m;o=1}if(l.is_end_fill){t.closePath();t.stroke();t.fill();t.fillStyle="#FFFFFF";o=0}if(l.is_start){t.beginPath();t.moveTo(n.x*u+f,n.y*s+e);n=l}else{if(n.x||n.x===0){t.lineTo(l.x*u+f,l.y*s+e);if(!o){t.stroke()}}else{Error("On index k = "+q+" lastObject not containt x ")}}}else{if(l.type==r.TYPE_RECT){if(l.fill_color){m=SE2D.parseColor(l.fill_color);t.fillStyle=m;t.fillRect(l.x*u+f,l.y*s+e,l.w*u,l.h*s)}else{t.strokeStyle=this.parseColor(l.color);t.strokeRect(l.x*u+f,l.y*s+e,l.w*u,l.h*s)}}}}else{Error("Unexpected object!")}}};SimpleEngine2D.prototype.parseColor=function(a){if(a==0){return"#000001"}a=Number(a).toString(16);while(a.length<6){a="0"+a}a="#"+a;return a};function E(a){return document.getElementById(a)}function trace(a){if(E("panel")){E("panel").innerHTML=a}};
